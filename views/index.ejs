<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสารบรรณ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; font-size: 14px; }
        
        /* --- 1. แก้ไขเมนูด้านบน (Top Navbar) --- */
        /* ให้ตัวหนังสือเป็นสีเทาเข้มเมื่อยังไม่เลือก */
        .navbar .nav-link { cursor: pointer; font-weight: bold; color: #555; }
        /* เมื่อเลือกแล้ว ให้เป็นสีน้ำเงิน และมีขีดเส้นใต้ */
        .navbar .nav-link.active { 
            color: #0d6efd !important; 
            border-bottom: 3px solid #0d6efd; 
            background-color: transparent !important; /* บังคับพื้นหลังใส */
        }

        /* --- 2. แก้ไขเมนูในหน้าตั้งค่า (Settings Sidebar) --- */
        /* เมื่อเลือกแล้ว ให้พื้นหลังน้ำเงิน ตัวหนังสือ "สีขาว" */
        #settingsModal .nav-pills .nav-link.active {
            background-color: #0d6efd !important;
            color: white !important; /* แก้จุดที่ตัวหนังสือหาย */
            border-bottom: none;
        }
        #settingsModal .nav-pills .nav-link {
            color: #555;
            margin-bottom: 5px;
            text-align: left;
        }

        /* --- 3. แก้ไข Dropdown (Select) --- */
        /* บังคับให้ตัวหนังสือในช่องเลือกเป็นสีดำเสมอ */
        select.form-select { color: #000 !important; }
        /* บังคับตัวเลือกข้างในเป็นพื้นขาว ตัวหนังสือดำ */
        select option { background-color: white !important; color: black !important; }
        
        /* Table Styles */
        table.dataTable { width: 100% !important; }
        table.dataTable thead th { 
            white-space: nowrap; 
            background-color: #e9ecef !important; /* สีเทาอ่อน */
            color: #000 !important; /* ตัวหนังสือดำ */
            vertical-align: middle; 
            border-bottom: 2px solid #dee2e6;
        }
        table.dataTable tbody td { vertical-align: middle; }
        
        /* Link Style */
        a.doc-link { text-decoration: none; font-weight: bold; color: #0d6efd; }
        a.doc-link:hover { text-decoration: underline; color: #004085; }

        /* Animation */
        .section-container { display: none; }
        .section-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand text-primary" href="#"><i class="fas fa-book-open"></i> งานสารบรรณ</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" onclick="switchTab('search')">ค้นหาหนังสือ</a></li>
                <li class="nav-item"><a class="nav-link" onclick="checkAuthAndSwitch()"><i class="fas fa-lock"></i> จัดการข้อมูล (Admin)</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4 px-4">
    
    <div id="searchSection" class="section-container active">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">รายการหนังสือทั้งหมด</h5>
                <div class="d-flex gap-2 align-items-center">
                    <span>เลือกสมุด:</span>
                    <select id="searchSheet" class="form-select form-select-sm w-auto fw-bold text-dark"><option>Loading...</option></select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="viewTable" class="table table-hover table-bordered w-100 table-sm display nowrap">
                        <thead class="table-light">
                            <tr>
                                <th>เลขทะเบียน</th>
                                <th>ความลับ</th>
                                <th>ความเร็ว</th>
                                <th>เลขที่หนังสือ</th>
                                <th>ลงวันที่</th>
                                <th>จาก</th>
                                <th>ถึง</th>
                                <th>เรื่อง</th>
                                <th>ฝ่าย</th>
                                <th>ผู้ปฏิบัติ</th>
                                <th>วิธีรับ</th>
                                <th>หมายเหตุ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="manageSection" class="section-container">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-user-shield"></i> จัดการข้อมูล</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-dark btn-sm" onclick="openSettings()"><i class="fas fa-cog"></i> ตั้งค่าตัวเลือก</button>
                    <button class="btn btn-success btn-sm" onclick="openModal('add')"><i class="fas fa-plus-circle"></i> ลงรับใหม่</button>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3 bg-light p-2 rounded">
                    <label class="fw-bold me-2">กำลังแก้ไขสมุด:</label>
                    <select id="manageSheet" class="form-select w-auto"><option>Loading...</option></select>
                </div>
                <div class="table-responsive">
                    <table id="editTable" class="table table-striped table-bordered w-100 table-sm display nowrap" style="width:100%">
                        <thead class="table-light"> <tr>
                                <th style="width: 50px;" class="text-center">แก้ไข</th>
                                <th>เลขทะเบียน</th>
                                <th>ความลับ</th>
                                <th>ความเร็ว</th>
                                <th>เลขที่หนังสือ</th>
                                <th>ลงวันที่</th>
                                <th>จาก</th>
                                <th>ถึง</th>
                                <th>เรื่อง</th>
                                <th>ฝ่าย</th>
                                <th>ผู้ปฏิบัติ</th>
                                <th>วิธีรับ</th>
                                <th>หมายเหตุ</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">ตั้งค่าตัวเลือก</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3 border-end">
                        <div class="nav flex-column nav-pills" id="setNav"></div>
                    </div>
                    <div class="col-md-9">
                        <h6 id="catTitle" class="fw-bold text-primary mb-3"></h6>
                        <div id="sheetHelp" class="alert alert-info py-1 small d-none"><i class="fas fa-info-circle"></i> เลือก Sheet จริงจาก Google</div>
                        <table class="table table-bordered table-sm" id="setTable"><thead class="table-light"></thead><tbody></tbody></table>
                        <button class="btn btn-sm btn-success w-100" onclick="addSetRow()">+ เพิ่มรายการใหม่</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveSettings()">บันทึก</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="dataModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalTitle">ฟอร์มบันทึก</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="docForm">
                    <input type="hidden" name="action" id="fAction">
                    <input type="hidden" name="rowIndex" id="fRowIndex">
                    <input type="hidden" name="oldFileUrl" id="fOldUrl">
                    <div class="mb-3">
                        <label class="fw-bold text-danger">บันทึกลงสมุด:</label>
                        <select name="sheetName" id="fSheet" class="form-select bg-light" required></select>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-3"><label>เลขทะเบียน</label><input type="text" name="regNo" class="form-control" required></div>
                        <div class="col-md-3"><label>วันที่</label><input type="date" name="date" class="form-control"></div>
                        <div class="col-md-3"><label>ความลับ</label><select name="secretLevel" id="fSecret" class="form-select"></select></div>
                        <div class="col-md-3"><label>ความเร็ว</label><select name="speedLevel" id="fSpeed" class="form-select"></select></div>
                        <div class="col-md-4"><label>เลขที่หนังสือ</label><input type="text" name="bookNo" class="form-control"></div>
                        <div class="col-md-4"><label>จาก</label><input type="text" name="from" class="form-control"></div>
                        <div class="col-md-4"><label>ถึง</label><input type="text" name="to" class="form-control"></div>
                        <div class="col-12"><label>เรื่อง</label><input type="text" name="subject" class="form-control" required></div>
                        <div class="col-md-4"><label>ฝ่าย</label><select name="dept" id="fDept" class="form-select"></select></div>
                        <div class="col-md-4"><label>ผู้ปฏิบัติ</label><select name="worker" id="fWorker" class="form-select"></select></div>
                        <div class="col-md-4"><label>วิธีรับ</label><select name="method" id="fMethod" class="form-select"></select></div>
                        <div class="col-12"><label>หมายเหตุ</label><input type="text" name="remark" class="form-control"></div>
                        <div class="col-12 mt-2"><label class="fw-bold"><i class="fas fa-paperclip"></i> ไฟล์ PDF</label><input type="file" name="pdfFile" class="form-control" accept="application/pdf"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-success" onclick="submitForm()">บันทึกข้อมูล</button></div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const ADMIN_PASSWORD = "1234"; 
let viewTable, editTable;
let allData=[], globalSet={}, autoSheets=[], curCat='sheet';
let isLoggedIn = false;
const cats = { sheet:'สมุดทะเบียน', secret:'ชั้นความลับ', speed:'ชั้นความเร็ว', dept:'ฝ่าย', worker:'ผู้ปฏิบัติ', method:'วิธีรับ' };

$(document).ready(function() {
    Promise.all([
        fetch('/api/settings').then(r=>r.json()),
        fetch('/api/data?type=getSheetNames').then(r=>r.json())
    ]).then(([settings, sheets]) => {
        globalSet = settings || {};
        autoSheets = sheets || [];
        initMainDropdowns();
        renderSettingsNav();
    });

    $('#searchSheet').change(function(){ loadTable($(this).val(), 'view') });
    $('#manageSheet').change(function(){ loadTable($(this).val(), 'edit') });
});

function checkAuthAndSwitch() {
    if(isLoggedIn) { switchTab('manage'); return; }
    Swal.fire({
        title: 'Admin Password', input: 'password', showCancelButton: true, confirmButtonText: 'Login',
        preConfirm: (pass) => { if(pass !== ADMIN_PASSWORD) Swal.showValidationMessage('Wrong password'); return true; }
    }).then((res) => {
        if(res.isConfirmed) { isLoggedIn = true; switchTab('manage'); Swal.fire({icon:'success', title:'Success', toast:true, position:'top-end', showConfirmButton:false, timer:1000}); }
    });
}

function switchTab(t) {
    $('.section-container').removeClass('active'); $('.nav-link').removeClass('active');
    if(t==='search') { 
        $('#searchSection').addClass('active'); $('.nav-link:eq(0)').addClass('active'); 
        if(viewTable) setTimeout(() => viewTable.columns.adjust().draw(), 200); 
    } else { 
        $('#manageSection').addClass('active'); $('.nav-link:eq(1)').addClass('active'); 
        if(editTable) setTimeout(() => editTable.columns.adjust().draw(), 200);
    }
}

function initMainDropdowns() {
    const sDD = $('#searchSheet'), mDD = $('#manageSheet'), fDD = $('#fSheet');
    sDD.empty(); mDD.empty(); fDD.empty();
    sDD.append('<option value="All" class="fw-bold" style="color:blue;">--- ค้นหาทั้งหมด ---</option>');
    let hasSheet = false;
    if(globalSet.sheet && globalSet.sheet.length > 0) {
        globalSet.sheet.forEach(s => { const h = `<option value="${s.value}">${s.label}</option>`; sDD.append(h); mDD.append(h); fDD.append(h); });
        hasSheet = true;
    } else {
        const noData = '<option disabled>กรุณาเพิ่มสมุดที่ปุ่มตั้งค่า</option>'; sDD.append(noData); mDD.append(noData); fDD.append(noData);
    }
    ['secret','speed','dept','worker','method'].forEach(k => popDD('#f'+k.charAt(0).toUpperCase()+k.slice(1), globalSet[k], true));
    if(hasSheet) { loadTable('All', 'view'); loadTable(globalSet.sheet[0].value, 'edit'); }
}
function popDD(sel, items, blank=false) {
    const d = $(sel); d.empty(); if(blank) d.append('<option value="">-</option>');
    if(items) items.forEach(i => d.append(`<option value="${i.value}">${i.label}</option>`));
}

function loadTable(sheet, mode) {
    const tid = mode==='view'?'#viewTable':'#editTable';
    if($.fn.DataTable.isDataTable(tid)) $(tid).DataTable().destroy();
    
    const renderLink = (d, t, r) => (r['ลิงก์ไฟล์แนบ'] && r['ลิงก์ไฟล์แนบ'].includes('http')) ? `<a href="${r['ลิงก์ไฟล์แนบ']}" target="_blank" class="doc-link"><i class="fas fa-file-pdf"></i> ${d}</a>` : d;
    const renderBadge = d => d ? `<span class="badge bg-secondary">${d}</span>` : '-';

    // คอลัมน์มาตรฐาน 12 ช่อง
    const dataColumns = [
        { data: "เลขทะเบียนลงรับ", render: renderLink },
        { data: "ชั้นความลับ", render: renderBadge },
        { data: "ชั้นความเร็ว" }, { data: "เลขที่หนังสือ" }, { data: "ลงวันที่" }, 
        { data: "จาก" }, { data: "ถึง" }, { data: "ชื่อเรื่อง", className: "text-wrap", width: "300px" },
        { data: "ฝ่าย" }, { data: "ผู้ปฏิบัติ" }, { data: "วิธีการรับเอกสาร" }, { data: "หมายเหตุ" }
    ];

    let cols = [];
    if(mode === 'view') {
        cols = dataColumns;
    } else {
        // เพิ่มปุ่มแก้ไขข้างหน้า
        cols = [
            { data: null, className: "text-center", width: "50px", render:(d,t,r,m)=>`<button class="btn btn-warning btn-sm" onclick="openModal('edit',${m.row})"><i class="fas fa-pen"></i></button>` },
            ...dataColumns
        ];
    }

    const dt = $(tid).DataTable({
        ajax: { url: "/api/data?sheet="+encodeURIComponent(sheet), dataSrc: j => { if(mode==='edit') allData=j; return j; } },
        columns: cols, order: [[ mode==='view'?0:1, "desc" ]],
        language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json" },
        autoWidth: false, scrollX: true, destroy: true
    });
    
    if(mode==='view') viewTable=dt; else editTable=dt;
}

function openSettings() { curCat='sheet'; renderSetTable(); renderSettingsNav(); new bootstrap.Modal('#settingsModal').show(); }
function renderSettingsNav() { const n = $('#setNav'); n.empty(); Object.keys(cats).forEach(k => n.append(`<button class="nav-link ${k==='sheet'?'active':''}" onclick="switchCat('${k}')">${cats[k]}</button>`)); }
function switchCat(c) { captureSet(); curCat=c; renderSetTable(); $('.nav-link').removeClass('active'); $(event.target).addClass('active'); }
function captureSet() {
    const arr = []; $('#setTable tbody tr').each(function() { if(curCat==='sheet') arr.push({label:$(this).find('.l').val(), value:$(this).find('.v').val()}); else { const v=$(this).find('.v').val(); arr.push({label:v, value:v}); } });
    globalSet[curCat] = arr;
}
function renderSetTable() {
    $('#catTitle').text(cats[curCat]); const h = $('#setTable thead'); h.empty(); const b = $('#setTable tbody'); b.empty();
    if(curCat === 'sheet') $('#sheetHelp').removeClass('d-none'); else $('#sheetHelp').addClass('d-none');
    if(curCat==='sheet') h.append('<tr><th>ชื่อที่แสดง (เช่น ปี 67)</th><th>เลือกสมุดจริง (Google Sheet)</th><th width="50">ลบ</th></tr>'); else h.append('<tr><th>ข้อมูล</th><th width="50">ลบ</th></tr>');
    (globalSet[curCat]||[]).forEach(i => addSetRow(i.label, i.value));
}
function addSetRow(l='', v='') {
    let tr = '';
    if(curCat==='sheet') {
        let opts = `<option value="" disabled ${v===''?'selected':''}>-- เลือก Sheet --</option>`;
        autoSheets.forEach(sName => { const selected = sName === v ? 'selected' : ''; opts += `<option value="${sName}" ${selected}>${sName}</option>`; });
        if(v && !autoSheets.includes(v)) opts += `<option value="${v}" selected>${v} (ไม่พบ)</option>`;
        tr = `<tr><td><input class="form-control l" value="${l}" placeholder="ชื่อสมุด"></td><td><select class="form-select v">${opts}</select></td><td><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove()">X</button></td></tr>`;
    } else { tr = `<tr><td><input class="form-control v" value="${l}"></td><td><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove()">X</button></td></tr>`; }
    $('#setTable tbody').append(tr);
}
function saveSettings() {
    captureSet(); let flat = []; Object.keys(globalSet).forEach(k => globalSet[k].forEach(i => flat.push([k, i.label, i.value])));
    Swal.fire({title:'บันทึก...', didOpen:()=>Swal.showLoading()});
    fetch('/api/save-settings', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({settings:flat})}).then(()=> location.reload());
}
function openModal(mode, idx) {
    $('#docForm')[0].reset(); $('#fSheet').val($('#manageSheet').val());
    if(mode==='add') { $('#modalTitle').text('เพิ่ม'); $('#fAction').val('add'); $('input[name="date"]').val(new Date().toISOString().split('T')[0]); }
    else {
        const d = allData[idx]; $('#modalTitle').text('แก้ไข'); $('#fAction').val('edit'); $('#fRowIndex').val(d.rowIndex); $('#fOldUrl').val(d['ลิงก์ไฟล์แนบ']);
        if(d.sheetName) $('#fSheet').val(d.sheetName);
        $('#fSecret').val(d['ชั้นความลับ']); $('#fSpeed').val(d['ชั้นความเร็ว']); $('#fDept').val(d['ฝ่าย']); $('#fWorker').val(d['ผู้ปฏิบัติ']); $('#fMethod').val(d['วิธีการรับเอกสาร']);
        $('input[name="regNo"]').val(d['เลขทะเบียนลงรับ']); $('input[name="bookNo"]').val(d['เลขที่หนังสือ']);
        $('input[name="subject"]').val(d['ชื่อเรื่อง']); $('input[name="from"]').val(d['จาก']); $('input[name="to"]').val(d['ถึง']); $('input[name="remark"]').val(d['หมายเหตุ']);
        if(d['ลงวันที่']) { const p=d['ลงวันที่'].split('/'); if(p.length===3) $('input[name="date"]').val(`${p[2]}-${p[1]}-${p[0]}`); }
    }
    new bootstrap.Modal('#dataModal').show();
}
function submitForm() {
    const fd = new FormData($('#docForm')[0]); Swal.fire({title:'บันทึก...', didOpen:()=>Swal.showLoading()});
    fetch('/submit', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{
        if(d.status==='success') Swal.fire('สำเร็จ','','success').then(()=>{ bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide(); loadTable($('#fSheet').val(), 'edit'); });
        else Swal.fire('Err', d.message, 'error');
    });
}
</script>
</body>
</html>
