<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบงานสารบรรณ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f6f9; font-size: 14px;}
        .container-fluid { max-width: 100%; padding: 20px; }
        /* ปรับแต่งลิงก์เลขทะเบียน */
        a.doc-link { color: #0d6efd; text-decoration: none; font-weight: bold; }
        a.doc-link:hover { text-decoration: underline; color: #0a58ca; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="card shadow-sm">
        <div class="card-header bg-white py-3">
            <div class="row align-items-center">
                <div class="col-md-4"><h5 class="mb-0 text-primary"><i class="fas fa-book"></i> ระบบทะเบียนรับหนังสือ</h5></div>
                <div class="col-md-4 text-center">
                    <select id="viewSheetSelector" class="form-select d-inline-block w-auto">
                            <option value="มกราคม">มกราคม</option>
                            <option value="กุมภาพันธ์">กุมภาพันธ์</option>
                            <option value="มีนาคม">มีนาคม</option>
                            <option value="เมษายน">เมษายน</option>
                            <option value="พฤษภาคม">พฤษภาคม</option>
                            <option value="มิถุนายน">มิถุนายน</option>
                            <option value="กรกฎาคม">กรกฎาคม</option>
                            <option value="สิงหาคม">สิงหาคม</option>
                            <option value="กันยายน">กันยายน</option>
                            <option value="ตุลาคม">ตุลาคม</option>
                            <option value="พฤศจิกายน">พฤศจิกายน</option>
                            <option value="ธันวาคม">ธันวาคม</option>
                    </select>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-primary" onclick="openModal('add')">
                        <i class="fas fa-plus"></i> ลงรับหนังสือ
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <table id="docTable" class="table table-bordered table-hover w-100">
                <thead class="table-light">
                    <tr>
                        <th style="width: 50px;">จัดการ</th> <th>เลขทะเบียน</th>
                        <th>ลงวันที่</th>
                        <th>เลขที่หนังสือ</th>
                        <th>เรื่อง</th>
                        <th>จาก</th>
                        <th>ถึง</th>
                        <th>ฝ่าย</th>
                        <th>ชั้นความลับ</th>
                        <th>ชั้นความเร็ว</th>
                        <th>หมายเหตุ</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="dataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle">ลงรับหนังสือ</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="docForm">
                    <input type="hidden" name="action" id="formAction" value="add"> <input type="hidden" name="rowIndex" id="formRowIndex"> <input type="hidden" name="oldFileUrl" id="formOldFileUrl"> <div class="alert alert-warning d-none" id="editAlert">
                        <small><i class="fas fa-info-circle"></i> คุณกำลังแก้ไขข้อมูล หากไม่อัปโหลดไฟล์ใหม่ ระบบจะใช้ไฟล์เดิม</small>
                    </div>

                    <div class="mb-3">
                        <label>เลือกสมุดทะเบียน</label>
                        <select name="sheetName" id="formSheetName" class="form-select">
                            <option value="มกราคม">มกราคม</option>
                            <option value="กุมภาพันธ์">กุมภาพันธ์</option>
                            <option value="มีนาคม">มีนาคม</option>
                            <option value="เมษายน">เมษายน</option>
                            <option value="พฤษภาคม">พฤษภาคม</option>
                            <option value="มิถุนายน">มิถุนายน</option>
                            <option value="กรกฎาคม">กรกฎาคม</option>
                            <option value="สิงหาคม">สิงหาคม</option>
                            <option value="กันยายน">กันยายน</option>
                            <option value="ตุลาคม">ตุลาคม</option>
                            <option value="พฤศจิกายน">พฤศจิกายน</option>
                            <option value="ธันวาคม">ธันวาคม</option>
                        </select>
                    </div>

                    <div class="row g-2">
                        <div class="col-md-3"><label>เลขทะเบียนรับ</label><input type="text" name="regNo" class="form-control" required></div>
                        <div class="col-md-3"><label>ลงวันที่</label><input type="date" name="date" class="form-control"></div>
                        <div class="col-md-3"><label>ชั้นความลับ</label>
                             <select name="secretLevel" class="form-select"><option value="ปกติ">ปกติ</option><option value="ลับ">ลับ</option></select>
                        </div>
                        <div class="col-md-3"><label>ชั้นความเร็ว</label>
                             <select name="speedLevel" class="form-select"><option value="ปกติ">ปกติ</option><option value="ด่วน">ด่วน</option></select>
                        </div>
                        
                        <div class="col-md-4"><label>เลขที่หนังสือ</label><input type="text" name="bookNo" class="form-control"></div>
                        <div class="col-md-4"><label>จาก</label><input type="text" name="from" class="form-control"></div>
                        <div class="col-md-4"><label>ถึง</label><input type="text" name="to" class="form-control"></div>
                        
                        <div class="col-12"><label>ชื่อเรื่อง</label><input type="text" name="subject" class="form-control" required></div>
                        
                        <div class="col-md-6"><label>ฝ่ายเจ้าของเรื่อง</label><input type="text" name="dept" class="form-control"></div>
                        <div class="col-md-6"><label>ผู้ปฏิบัติ</label><input type="text" name="worker" class="form-control"></div>
                        <div class="col-md-6"><label>วิธีรับ</label><input type="text" name="method" class="form-control"></div>
                        <div class="col-md-6"><label>หมายเหตุ</label><input type="text" name="remark" class="form-control"></div>

                        <div class="col-12 mt-3">
                            <label>ไฟล์เอกสาร (PDF)</label>
                            <input type="file" name="pdfFile" class="form-control" accept="application/pdf">
                            <div id="currentFileLink" class="mt-1 small"></div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                <button type="button" class="btn btn-primary" onclick="submitForm()">บันทึกข้อมูล</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    let table;
    let allData = []; // เก็บข้อมูลไว้ใช้ตอนกด Edit

    $(document).ready(function() {
        loadTableData('Sheet1');
        $('#viewSheetSelector').on('change', function() { loadTableData($(this).val()); });
    });

    function loadTableData(sheetName) {
        if ($.fn.DataTable.isDataTable('#docTable')) { $('#docTable').DataTable().destroy(); }

        table = $('#docTable').DataTable({
            "ajax": {
                "url": "/api/data?sheet=" + encodeURIComponent(sheetName),
                "dataSrc": function(json) {
                    allData = json; // จำข้อมูลทั้งหมดไว้
                    return json;
                }
            },
            "columns": [
                { 
                    // ปุ่มแก้ไข
                    "data": null,
                    "render": function(data, type, row, meta) {
                        // ส่ง index ของ array ไปให้ฟังก์ชัน edit
                        return `<button class="btn btn-sm btn-warning" onclick="openModal('edit', ${meta.row})"><i class="fas fa-edit"></i></button>`;
                    }
                },
                { 
                    // เลขทะเบียนที่เป็น Link
                    "data": "เลขทะเบียนลงรับ",
                    "render": function(data, type, row) {
                        const link = row['ลิงก์ไฟล์แนบ']; // ชื่อหัวตารางใน Sheet ต้องตรงเป๊ะ
                        if (link && link.includes('http')) {
                            return `<a href="${link}" target="_blank" class="doc-link"><i class="fas fa-file-pdf"></i> ${data}</a>`;
                        }
                        return data || '-';
                    }
                },
                { 
                    "data": "ลงวันที่",
                    "render": function(data) { return data ? new Date(data).toLocaleDateString('th-TH') : '-'; }
                },
                { "data": "เลขที่หนังสือ", "defaultContent": "" },
                { "data": "ชื่อเรื่อง", "defaultContent": "" },
                { "data": "จาก", "defaultContent": "" },
                { "data": "ถึง", "defaultContent": "" },
                { "data": "ฝ่าย", "defaultContent": "" },
                { "data": "ชั้นความลับ", "defaultContent": "" },
                { "data": "ชั้นความเร็ว", "defaultContent": "" },
                { "data": "หมายเหตุ", "defaultContent": "" }
            ],
            "order": [[ 1, "desc" ]], // เรียงตามเลขทะเบียน (Column Index 1)
            "scrollX": true // ให้เลื่อนซ้ายขวาได้ถ้าตารางยาว
        });
    }

    // ฟังก์ชันเปิด Modal (ใช้ร่วมกันทั้ง Add และ Edit)
    function openModal(mode, rowIndex = null) {
        const modal = new bootstrap.Modal(document.getElementById('dataModal'));
        const form = document.getElementById('docForm');
        
        // Reset Form ก่อน
        form.reset();
        $('#currentFileLink').html('');
        
        if (mode === 'add') {
            $('#modalTitle').text('ลงรับหนังสือใหม่');
            $('#formAction').val('add');
            $('#formRowIndex').val('');
            $('#editAlert').addClass('d-none');
            // เซ็ต Dropdown ในฟอร์มให้ตรงกับหน้าตาราง
            $('#formSheetName').val($('#viewSheetSelector').val()); 

        } else if (mode === 'edit') {
            const data = allData[rowIndex]; // ดึงข้อมูลจาก Array ที่จำไว้
            
            $('#modalTitle').text('แก้ไขข้อมูล');
            $('#formAction').val('edit');
            $('#formRowIndex').val(data.rowIndex); // สำคัญ: ส่ง rowIndex ไปด้วย
            $('#formOldFileUrl').val(data['ลิงก์ไฟล์แนบ']);
            $('#formSheetName').val($('#viewSheetSelector').val());
            $('#editAlert').removeClass('d-none');

            // เติมข้อมูลลงฟอร์ม (ต้องใส่ชื่อ name ใน input ให้ตรง)
            $('input[name="regNo"]').val(data['เลขทะเบียนลงรับ']);
            $('input[name="bookNo"]').val(data['เลขที่หนังสือ']);
            $('input[name="subject"]').val(data['ชื่อเรื่อง']);
            $('input[name="from"]').val(data['จาก']);
            $('input[name="to"]').val(data['ถึง']);
            $('input[name="dept"]').val(data['ฝ่าย']);
            $('input[name="worker"]').val(data['ผู้ปฏิบัติ']);
            $('input[name="method"]').val(data['วิธีการรับเอกสาร']);
            $('input[name="remark"]').val(data['หมายเหตุ']);
            $('select[name="secretLevel"]').val(data['ชั้นความลับ']);
            $('select[name="speedLevel"]').val(data['ชั้นความเร็ว']);
            
            // แปลงวันที่สำหรับใส่ใน input type="date"
            if(data['ลงวันที่']) {
                const d = new Date(data['ลงวันที่']);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                $('input[name="date"]').val(`${yyyy}-${mm}-${dd}`);
            }

            if(data['ลิงก์ไฟล์แนบ']) {
                $('#currentFileLink').html(`ไฟล์ปัจจุบัน: <a href="${data['ลิงก์ไฟล์แนบ']}" target="_blank">เปิดดู</a>`);
            }
        }

        modal.show();
    }

    function submitForm() {
        const form = document.getElementById('docForm');
        const formData = new FormData(form);

        Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => { Swal.showLoading() } });

        fetch('/submit', { method: 'POST', body: formData })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                Swal.fire('สำเร็จ', 'บันทึกเรียบร้อย', 'success').then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
                    loadTableData($('#viewSheetSelector').val());
                });
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        });
    }
</script>
</body>
</html>
