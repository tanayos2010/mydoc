<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสารบรรณ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .nav-link { cursor: pointer; font-weight: bold; color: #555; }
        .nav-link.active { color: #0d6efd !important; border-bottom: 3px solid #0d6efd; }
        .section-container { display: none; }
        .section-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* แก้ Dropdown สีน้ำเงิน */
        select option { background-color: white !important; color: black !important; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand text-primary" href="#"><i class="fas fa-book-open"></i> งานสารบรรณ</a>
        <div class="d-flex">
            <button class="btn btn-outline-secondary btn-sm me-3" onclick="openSettings()"><i class="fas fa-cog"></i> ตั้งค่า</button>
        </div>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" onclick="switchTab('search')">ค้นหา</a></li>
                <li class="nav-item"><a class="nav-link" onclick="switchTab('manage')">จัดการข้อมูล</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <div id="searchSection" class="section-container active">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white d-flex justify-content-between">
                <h5 class="mb-0">ค้นหาหนังสือ</h5>
                <select id="searchSheet" class="form-select form-select-sm w-auto fw-bold"><option>Loading...</option></select>
            </div>
            <div class="card-body">
                <table id="viewTable" class="table table-hover table-bordered w-100 table-sm">
                    <thead class="table-light"><tr><th>ทะเบียน</th><th>วันที่</th><th>เรื่อง</th><th>จาก</th><th>ถึง</th><th>สถานะ</th><th>เอกสาร</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="manageSection" class="section-container">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-warning text-dark d-flex justify-content-between">
                <h5 class="mb-0">จัดการข้อมูล</h5>
                <button class="btn btn-success btn-sm" onclick="openModal('add')">+ ลงรับใหม่</button>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3 bg-light p-2 rounded">
                    <label class="fw-bold me-2">เลือกเล่ม:</label>
                    <select id="manageSheet" class="form-select w-auto"><option>Loading...</option></select>
                </div>
                <table id="editTable" class="table table-striped table-bordered w-100 table-sm">
                    <thead class="table-dark"><tr><th width="50">แก้ไข</th><th>ทะเบียน</th><th>เรื่อง</th><th>วันที่</th><th>ผู้ปฏิบัติ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">ตั้งค่าตัวเลือก</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-3 border-end">
                        <div class="nav flex-column nav-pills" id="setNav"></div>
                    </div>
                    <div class="col-9">
                        <h6 id="catTitle" class="fw-bold text-primary mb-3"></h6>
                        <table class="table table-bordered table-sm" id="setTable">
                            <thead class="table-light"></thead>
                            <tbody></tbody>
                        </table>
                        <button class="btn btn-sm btn-success w-100" onclick="addSetRow()">+ เพิ่ม</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveSettings()">บันทึก</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="dataModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalTitle">ฟอร์มบันทึก</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="docForm">
                    <input type="hidden" name="action" id="fAction">
                    <input type="hidden" name="rowIndex" id="fRowIndex">
                    <input type="hidden" name="oldFileUrl" id="fOldUrl">
                    
                    <div class="mb-3">
                        <label class="fw-bold text-danger">สมุดทะเบียน:</label>
                        <select name="sheetName" id="fSheet" class="form-select bg-light" required></select>
                    </div>
                    <div class="row g-2">
                        <div class="col-3"><label>เลขทะเบียน</label><input type="text" name="regNo" class="form-control" required></div>
                        <div class="col-3"><label>วันที่</label><input type="date" name="date" class="form-control"></div>
                        <div class="col-3"><label>ความลับ</label><select name="secretLevel" id="fSecret" class="form-select"></select></div>
                        <div class="col-3"><label>ความเร็ว</label><select name="speedLevel" id="fSpeed" class="form-select"></select></div>
                        
                        <div class="col-4"><label>เลขที่หนังสือ</label><input type="text" name="bookNo" class="form-control"></div>
                        <div class="col-4"><label>จาก</label><input type="text" name="from" class="form-control"></div>
                        <div class="col-4"><label>ถึง</label><input type="text" name="to" class="form-control"></div>
                        <div class="col-12"><label>เรื่อง</label><input type="text" name="subject" class="form-control" required></div>
                        
                        <div class="col-4"><label>ฝ่าย</label><select name="dept" id="fDept" class="form-select"></select></div>
                        <div class="col-4"><label>ผู้ปฏิบัติ</label><select name="worker" id="fWorker" class="form-select"></select></div>
                        <div class="col-4"><label>วิธีรับ</label><select name="method" id="fMethod" class="form-select"></select></div>
                        <div class="col-12"><label>หมายเหตุ</label><input type="text" name="remark" class="form-control"></div>
                        <div class="col-12"><label>ไฟล์ PDF</label><input type="file" name="pdfFile" class="form-control" accept="application/pdf"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-success" onclick="submitForm()">บันทึก</button></div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
let viewTable, editTable, allData=[], globalSet={}, autoSheets=[], curCat='sheet';
const cats = { sheet:'สมุดทะเบียน', secret:'ชั้นความลับ', speed:'ชั้นความเร็ว', dept:'ฝ่าย', worker:'ผู้ปฏิบัติ', method:'วิธีรับ' };

$(document).ready(function() {
    // 1. Initial Load
    Promise.all([
        fetch('/api/settings').then(r=>r.json()),
        fetch('/api/data?type=getSheetNames').then(r=>r.json())
    ]).then(([settings, sheets]) => {
        globalSet = settings || {};
        autoSheets = sheets || [];
        
        initDropdowns();
        renderSettingsNav();
    });

    $('#searchSheet').change(function(){ loadTable($(this).val(), 'view') });
    $('#manageSheet').change(function(){ loadTable($(this).val(), 'edit') });
});

function initDropdowns() {
    // Sheet Dropdown Logic
    const sDD = $('#searchSheet'), mDD = $('#manageSheet'), fDD = $('#fSheet');
    sDD.empty(); mDD.empty(); fDD.empty();
    
    sDD.append('<option value="All" class="fw-bold">--- ทั้งหมด ---</option>');
    
    // Merge Config + Auto
    let opts = [];
    if(globalSet.sheet) globalSet.sheet.forEach(s => opts.push({l:s.label, v:s.value}));
    autoSheets.forEach(n => { if(!opts.find(o=>o.v===n)) opts.push({l:n, v:n}); });

    opts.forEach(o => {
        const h = `<option value="${o.v}">${o.l}</option>`;
        sDD.append(h); mDD.append(h); fDD.append(h);
    });

    // Other Dropdowns
    ['secret','speed','dept','worker','method'].forEach(k => popDD('#f'+k.charAt(0).toUpperCase()+k.slice(1), globalSet[k], true));

    // Load Default Data
    if(opts.length>0) {
        loadTable('All', 'view');
        loadTable(opts[0].v, 'edit');
    }
}

function popDD(sel, items, blank=false) {
    const d = $(sel); d.empty();
    if(blank) d.append('<option value="">-</option>');
    if(items) items.forEach(i => d.append(`<option value="${i.value}">${i.label}</option>`));
}

// --- Table ---
function loadTable(sheet, mode) {
    const tid = mode==='view'?'#viewTable':'#editTable';
    if($.fn.DataTable.isDataTable(tid)) $(tid).DataTable().destroy();
    
    const cols = mode==='view' 
        ? [{data:"เลขทะเบียนลงรับ"},{data:"ลงวันที่"},{data:"ชื่อเรื่อง"},{data:"จาก"},{data:"ถึง"},{data:"ชั้นความลับ", render:d=>`<span class="badge bg-secondary">${d}</span>`},{data:"ลิงก์ไฟล์แนบ", render:d=>d?`<a href="${d}" target="_blank" class="btn btn-sm btn-outline-primary">PDF</a>`:'-'}]
        : [{data:null, render:(d,t,r,m)=>`<button class="btn btn-warning btn-sm" onclick="openModal('edit',${m.row})">แก้</button>`},{data:"เลขทะเบียนลงรับ"},{data:"ชื่อเรื่อง"},{data:"ลงวันที่"},{data:"ผู้ปฏิบัติ"}];

    const dt = $(tid).DataTable({
        ajax: { url: "/api/data?sheet="+encodeURIComponent(sheet), dataSrc: j => { if(mode==='edit') allData=j; return j; } },
        columns: cols, order:[[1,'desc']], language:{url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json"}
    });
    if(mode==='view') viewTable=dt; else editTable=dt;
}

// --- Settings ---
function openSettings() { curCat='sheet'; renderSetTable(); new bootstrap.Modal('#settingsModal').show(); }
function renderSettingsNav() {
    const n = $('#setNav'); n.empty();
    Object.keys(cats).forEach(k => n.append(`<button class="nav-link ${k==='sheet'?'active':''}" onclick="switchCat('${k}')">${cats[k]}</button>`));
}
function switchCat(c) { captureSet(); curCat=c; renderSetTable(); $('.nav-link').removeClass('active'); $(event.target).addClass('active'); }

function captureSet() {
    const arr = [];
    $('#setTable tbody tr').each(function() {
        if(curCat==='sheet') arr.push({label:$(this).find('.l').val(), value:$(this).find('.v').val()});
        else { const v=$(this).find('.v').val(); arr.push({label:v, value:v}); }
    });
    globalSet[curCat] = arr;
}

function renderSetTable() {
    $('#catTitle').text(cats[curCat]);
    const h = $('#setTable thead'); h.empty();
    const b = $('#setTable tbody'); b.empty();
    
    if(curCat==='sheet') h.append('<tr><th>ชื่อโชว์</th><th>ชื่อ Sheet จริง</th><th width="50">ลบ</th></tr>');
    else h.append('<tr><th>ข้อมูล</th><th width="50">ลบ</th></tr>');

    (globalSet[curCat]||[]).forEach(i => addSetRow(i.label, i.value));
}

function addSetRow(l='', v='') {
    let tr = '';
    if(curCat==='sheet') tr = `<tr><td><input class="form-control l" value="${l}"></td><td><input class="form-control v" value="${v}"></td><td><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove()">X</button></td></tr>`;
    else tr = `<tr><td><input class="form-control v" value="${l}"></td><td><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove()">X</button></td></tr>`;
    $('#setTable tbody').append(tr);
}

function saveSettings() {
    captureSet();
    let flat = [];
    Object.keys(globalSet).forEach(k => globalSet[k].forEach(i => flat.push([k, i.label, i.value])));
    
    fetch('/api/save-settings', {
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({settings:flat})
    }).then(()=> location.reload());
}

// --- Tabs & Modal ---
function switchTab(t) {
    $('.section-container').removeClass('active'); $('.nav-link').removeClass('active');
    if(t==='search') { $('#searchSection').addClass('active'); if(viewTable) viewTable.columns.adjust().draw(); }
    else { $('#manageSection').addClass('active'); if(editTable) editTable.columns.adjust().draw(); }
}

function openModal(mode, idx) {
    $('#docForm')[0].reset();
    $('#fSheet').val($('#manageSheet').val());
    if(mode==='add') { 
        $('#modalTitle').text('เพิ่ม'); $('#fAction').val('add'); 
        $('input[name="date"]').val(new Date().toISOString().split('T')[0]);
    } else {
        const d = allData[idx];
        $('#modalTitle').text('แก้ไข'); $('#fAction').val('edit'); $('#fRowIndex').val(d.rowIndex); $('#fOldUrl').val(d['ลิงก์ไฟล์แนบ']);
        if(d.sheetName) $('#fSheet').val(d.sheetName);
        $('#fSecret').val(d['ชั้นความลับ']); $('#fSpeed').val(d['ชั้นความเร็ว']); $('#fDept').val(d['ฝ่าย']);
        $('#fWorker').val(d['ผู้ปฏิบัติ']); $('#fMethod').val(d['วิธีการรับเอกสาร']);
        $('input[name="regNo"]').val(d['เลขทะเบียนลงรับ']); $('input[name="bookNo"]').val(d['เลขที่หนังสือ']);
        $('input[name="subject"]').val(d['ชื่อเรื่อง']); $('input[name="from"]').val(d['จาก']); $('input[name="to"]').val(d['ถึง']); $('input[name="remark"]').val(d['หมายเหตุ']);
        if(d['ลงวันที่']) { const p=d['ลงวันที่'].split('/'); if(p.length===3) $('input[name="date"]').val(`${p[2]}-${p[1]}-${p[0]}`); }
    }
    new bootstrap.Modal('#dataModal').show();
}

function submitForm() {
    const fd = new FormData($('#docForm')[0]);
    Swal.fire({title:'บันทึก...', didOpen:()=>Swal.showLoading()});
    fetch('/submit', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{
        if(d.status==='success') Swal.fire('สำเร็จ','','success').then(()=>{
            bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide();
            loadTable($('#fSheet').val(), 'edit');
        });
        else Swal.fire('Err', d.message, 'error');
    });
}
</script>
</body>
</html>
