<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; font-size: 14px; }
        .nav-link { cursor: pointer; font-weight: bold; color: #555; }
        .nav-link.active { color: #0d6efd !important; border-bottom: 3px solid #0d6efd; }
        
        /* Animation */
        .section-container { display: none; }
        .section-container.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Fix Dropdown Color */
        select option { background-color: white !important; color: black !important; }
        
        /* Fix Table Layout (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) */
        table.dataTable { width: 100% !important; } /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏° 100% ‡πÄ‡∏™‡∏°‡∏≠ */
        table.dataTable thead th { 
            white-space: nowrap; /* ‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥ */
            background-color: #f8f9fa; 
            vertical-align: middle; 
        }
        table.dataTable tbody td { 
            vertical-align: middle; 
            white-space: nowrap; /* ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥ (‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô scroll ‡πÄ‡∏≠‡∏≤) */
        }
        
        /* Link Style */
        a.doc-link { text-decoration: none; font-weight: bold; color: #0d6efd; }
        a.doc-link:hover { text-decoration: underline; color: #004085; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand text-primary" href="#"><i class="fas fa-book-open"></i> ‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏ì</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" onclick="switchTab('search')">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</a></li>
                <li class="nav-item"><a class="nav-link" onclick="checkAuthAndSwitch()"><i class="fas fa-lock"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Admin)</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container-fluid mt-4 px-4">
    
    <div id="searchSection" class="section-container active">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h5>
                <div class="d-flex gap-2 align-items-center">
                    <span>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏∏‡∏î:</span>
                    <select id="searchSheet" class="form-select form-select-sm w-auto fw-bold text-dark">
                        <option>Loading...</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="viewTable" class="table table-hover table-bordered w-100 table-sm display nowrap">
                        <thead class="table-light">
                            <tr>
                                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                                <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</th>
                                <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</th>
                                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th>
                                <th>‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡∏à‡∏≤‡∏Å</th>
                                <th>‡∏ñ‡∏∂‡∏á</th>
                                <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                                <th>‡∏ù‡πà‡∏≤‡∏¢</th>
                                <th>‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</th>
                                <th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö</th>
                                <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="manageSection" class="section-container">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-user-shield"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-dark btn-sm" onclick="openSettings()"><i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
                    <button class="btn btn-success btn-sm" onclick="openModal('add')"><i class="fas fa-plus-circle"></i> ‡∏•‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-center mb-3 bg-light p-2 rounded">
                    <label class="fw-bold me-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏°‡∏∏‡∏î:</label>
                    <select id="manageSheet" class="form-select w-auto"><option>Loading...</option></select>
                </div>
                <div class="table-responsive">
                    <table id="editTable" class="table table-striped table-bordered w-100 table-sm display nowrap" style="width:100%">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 50px;" class="text-center">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                                <th style="width: 120px;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                                <th>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</th>
                                <th style="width: 100px;">‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th style="width: 150px;">‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-3 border-end">
                        <div class="nav flex-column nav-pills" id="setNav"></div>
                    </div>
                    <div class="col-md-9">
                        <h6 id="catTitle" class="fw-bold text-primary mb-3"></h6>
                        <div id="sheetHelp" class="alert alert-info py-1 small d-none">
                            <i class="fas fa-info-circle"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sheet ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Google Sheet ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
                        </div>
                        <table class="table table-bordered table-sm" id="setTable">
                            <thead class="table-light"></thead>
                            <tbody></tbody>
                        </table>
                        <button class="btn btn-sm btn-success w-100" onclick="addSetRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveSettings()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
        </div>
    </div>
</div>

<div class="modal fade" id="dataModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalTitle">‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="docForm">
                    <input type="hidden" name="action" id="fAction">
                    <input type="hidden" name="rowIndex" id="fRowIndex">
                    <input type="hidden" name="oldFileUrl" id="fOldUrl">
                    <div class="mb-3">
                        <label class="fw-bold text-danger">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏™‡∏°‡∏∏‡∏î:</label>
                        <select name="sheetName" id="fSheet" class="form-select bg-light" required></select>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-3"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</label><input type="text" name="regNo" class="form-control" required></div>
                        <div class="col-md-3"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" name="date" class="form-control"></div>
                        <div class="col-md-3"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö</label><select name="secretLevel" id="fSecret" class="form-select"></select></div>
                        <div class="col-md-3"><label>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</label><select name="speedLevel" id="fSpeed" class="form-select"></select></div>
                        <div class="col-md-4"><label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label><input type="text" name="bookNo" class="form-control"></div>
                        <div class="col-md-4"><label>‡∏à‡∏≤‡∏Å</label><input type="text" name="from" class="form-control"></div>
                        <div class="col-md-4"><label>‡∏ñ‡∏∂‡∏á</label><input type="text" name="to" class="form-control"></div>
                        <div class="col-12"><label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</label><input type="text" name="subject" class="form-control" required></div>
                        <div class="col-md-4"><label>‡∏ù‡πà‡∏≤‡∏¢</label><select name="dept" id="fDept" class="form-select"></select></div>
                        <div class="col-md-4"><label>‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</label><select name="worker" id="fWorker" class="form-select"></select></div>
                        <div class="col-md-4"><label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö</label><select name="method" id="fMethod" class="form-select"></select></div>
                        <div class="col-12"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" name="remark" class="form-control"></div>
                        <div class="col-12 mt-2"><label class="fw-bold"><i class="fas fa-paperclip"></i> ‡πÑ‡∏ü‡∏•‡πå PDF</label><input type="file" name="pdfFile" class="form-control" accept="application/pdf"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer"><button class="btn btn-success" onclick="submitForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button></div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.0.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ============================================
// üîí ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin
// ============================================
const ADMIN_PASSWORD = "1234"; 

let viewTable, editTable;
let allData=[], globalSet={}, autoSheets=[], curCat='sheet';
let isLoggedIn = false;
const cats = { sheet:'‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô', secret:'‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö', speed:'‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß', dept:'‡∏ù‡πà‡∏≤‡∏¢', worker:'‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥', method:'‡∏ß‡∏¥‡∏ò‡∏µ‡∏£‡∏±‡∏ö' };

$(document).ready(function() {
    Promise.all([
        fetch('/api/settings').then(r=>r.json()),
        fetch('/api/data?type=getSheetNames').then(r=>r.json())
    ]).then(([settings, sheets]) => {
        globalSet = settings || {};
        autoSheets = sheets || [];
        initMainDropdowns();
        renderSettingsNav();
    });

    $('#searchSheet').change(function(){ loadTable($(this).val(), 'view') });
    $('#manageSheet').change(function(){ loadTable($(this).val(), 'edit') });
});

// --- Auth & Tabs ---
function checkAuthAndSwitch() {
    if(isLoggedIn) { switchTab('manage'); return; }
    Swal.fire({
        title: 'Admin Password', input: 'password', showCancelButton: true, confirmButtonText: 'Login',
        preConfirm: (pass) => { if(pass !== ADMIN_PASSWORD) Swal.showValidationMessage('Wrong password'); return true; }
    }).then((res) => {
        if(res.isConfirmed) {
            isLoggedIn = true;
            switchTab('manage');
            Swal.fire({icon:'success', title:'Login Success', toast:true, position:'top-end', showConfirmButton:false, timer:1500});
        }
    });
}

function switchTab(t) {
    $('.section-container').removeClass('active'); $('.nav-link').removeClass('active');
    if(t==='search') { 
        $('#searchSection').addClass('active'); $('.nav-link:eq(0)').addClass('active'); 
        // **‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á**: ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        if(viewTable) setTimeout(() => viewTable.columns.adjust().draw(), 200); 
    } else { 
        $('#manageSection').addClass('active'); $('.nav-link:eq(1)').addClass('active'); 
        // **‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á**: ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
        if(editTable) setTimeout(() => editTable.columns.adjust().draw(), 200);
    }
}

// --- Dropdowns ---
function initMainDropdowns() {
    const sDD = $('#searchSheet'), mDD = $('#manageSheet'), fDD = $('#fSheet');
    sDD.empty(); mDD.empty(); fDD.empty();
    sDD.append('<option value="All" class="fw-bold" style="color:blue;">--- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---</option>');
    
    let hasSheet = false;
    if(globalSet.sheet && globalSet.sheet.length > 0) {
        globalSet.sheet.forEach(s => {
            const h = `<option value="${s.value}">${s.label}</option>`;
            sDD.append(h); mDD.append(h); fDD.append(h);
        });
        hasSheet = true;
    } else {
        const noData = '<option disabled>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</option>';
        sDD.append(noData); mDD.append(noData); fDD.append(noData);
    }
    ['secret','speed','dept','worker','method'].forEach(k => popDD('#f'+k.charAt(0).toUpperCase()+k.slice(1), globalSet[k], true));

    if(hasSheet) {
        loadTable('All', 'view');
        loadTable(globalSet.sheet[0].value, 'edit');
    }
}
function popDD(sel, items, blank=false) {
    const d = $(sel); d.empty();
    if(blank) d.append('<option value="">-</option>');
    if(items) items.forEach(i => d.append(`<option value="${i.value}">${i.label}</option>`));
}

// --- Table Logic ---
function loadTable(sheet, mode) {
    const tid = mode==='view'?'#viewTable':'#editTable';
    if($.fn.DataTable.isDataTable(tid)) $(tid).DataTable().destroy();
    
    const renderLink = (data, type, row) => {
        if(row['‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö'] && row['‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö'].includes('http')) {
            return `<a href="${row['‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö']}" target="_blank" class="doc-link"><i class="fas fa-file-pdf"></i> ${data}</a>`;
        }
        return data;
    };

    let cols = [];
    if(mode === 'view') {
        cols = [
            { data: "‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏£‡∏±‡∏ö", render: renderLink }, { data: "‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö", render: d=>d?`<span class="badge bg-secondary">${d}</span>`:'-' },
            { data: "‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß" }, { data: "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠" }, { data: "‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" }, { data: "‡∏à‡∏≤‡∏Å" }, { data: "‡∏ñ‡∏∂‡∏á" }, { data: "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" }, { data: "‡∏ù‡πà‡∏≤‡∏¢" }, { data: "‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥" }, { data: "‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£" }, { data: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" }
        ];
    } else {
        // **‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Edit)**
        cols = [
            { data: null, className: "text-center", width: "50px", render:(d,t,r,m)=>`<button class="btn btn-warning btn-sm" onclick="openModal('edit',${m.row})"><i class="fas fa-pen"></i></button>` },
            { data: "‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏£‡∏±‡∏ö", width: "120px", render: renderLink },
            { data: "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á" }, // ‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô (Auto width)
            { data: "‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà", className: "text-center", width: "100px" },
            { data: "‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥", width: "150px" }
        ];
    }

    const dt = $(tid).DataTable({
        ajax: { url: "/api/data?sheet="+encodeURIComponent(sheet), dataSrc: j => { if(mode==='edit') allData=j; return j; } },
        columns: cols, order: [[ 1, "desc" ]],
        language: { url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/th.json" },
        autoWidth: false, // ‡∏õ‡∏¥‡∏î auto width ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∏‡∏°‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ
        scrollX: true,    // ‡πÄ‡∏õ‡∏¥‡∏î scroll ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô
        destroy: true
    });
    
    if(mode==='view') viewTable=dt; else editTable=dt;
}

// --- Settings & Forms ---
function openSettings() { curCat='sheet'; renderSetTable(); renderSettingsNav(); new bootstrap.Modal('#settingsModal').show(); }
function renderSettingsNav() { const n = $('#setNav'); n.empty(); Object.keys(cats).forEach(k => n.append(`<button class="nav-link ${k==='sheet'?'active':''}" onclick="switchCat('${k}')">${cats[k]}</button>`)); }
function switchCat(c) { captureSet(); curCat=c; renderSetTable(); $('.nav-link').removeClass('active'); $(event.target).addClass('active'); }
function captureSet() {
    const arr = [];
    $('#setTable tbody tr').each(function() {
        if(curCat==='sheet') arr.push({label:$(this).find('.l').val(), value:$(this).find('.v').val()});
        else { const v=$(this).find('.v').val(); arr.push({label:v, value:v}); }
    });
    globalSet[curCat] = arr;
}
function renderSetTable() {
    $('#catTitle').text(cats[curCat]);
    const h = $('#setTable thead'); h.empty(); const b = $('#setTable tbody'); b.empty();
    if(curCat === 'sheet') $('#sheetHelp').removeClass('d-none'); else $('#sheetHelp').addClass('d-none');
    if(curCat==='sheet') h.append('<tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏µ 67)</th><th>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á (Google Sheet)</th><th width="50">‡∏•‡∏ö</th></tr>');
    else h.append('<tr><th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th><th width="50">‡∏•‡∏ö</th></tr>');
    (globalSet[curCat]||[]).forEach(i => addSetRow(i.label, i.value));
}
function addSetRow(l='', v='') {
    let tr = '';
    if(curCat==='sheet') {
        let opts = `<option value="" disabled ${v===''?'selected':''}>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Sheet --</option>`;
        autoSheets.forEach(sName => {
            const selected = sName === v ? 'selected' : '';
            opts += `<option value="${sName}" ${selected}>${sName}</option>`;
        });
        if(v && !autoSheets.includes(v)) opts += `<option value="${v}" selected>${v} (‡πÑ‡∏°‡πà‡∏û‡∏ö)</option>`;
        tr = `<tr><td><input class="form-control l" value="${l}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏∏‡∏î"></td><td><select class="form-select v">${opts}</select></td><td><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove()">X</button></td></tr>`;
    } else {
        tr = `<tr><td><input class="form-control v" value="${l}"></td><td><button class="btn btn-danger btn-sm" onclick="$(this).closest('tr').remove()">X</button></td></tr>`;
    }
    $('#setTable tbody').append(tr);
}
function saveSettings() {
    captureSet(); let flat = []; Object.keys(globalSet).forEach(k => globalSet[k].forEach(i => flat.push([k, i.label, i.value])));
    Swal.fire({title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading()});
    fetch('/api/save-settings', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({settings:flat})}).then(()=> location.reload());
}
function openModal(mode, idx) {
    $('#docForm')[0].reset(); $('#fSheet').val($('#manageSheet').val());
    if(mode==='add') { $('#modalTitle').text('‡πÄ‡∏û‡∏¥‡πà‡∏°'); $('#fAction').val('add'); $('input[name="date"]').val(new Date().toISOString().split('T')[0]); }
    else {
        const d = allData[idx];
        $('#modalTitle').text('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'); $('#fAction').val('edit'); $('#fRowIndex').val(d.rowIndex); $('#fOldUrl').val(d['‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö']);
        if(d.sheetName) $('#fSheet').val(d.sheetName);
        $('#fSecret').val(d['‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö']); $('#fSpeed').val(d['‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß']); $('#fDept').val(d['‡∏ù‡πà‡∏≤‡∏¢']); $('#fWorker').val(d['‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥']); $('#fMethod').val(d['‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£']);
        $('input[name="regNo"]').val(d['‡πÄ‡∏•‡∏Ç‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏£‡∏±‡∏ö']); $('input[name="bookNo"]').val(d['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠']);
        $('input[name="subject"]').val(d['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á']); $('input[name="from"]').val(d['‡∏à‡∏≤‡∏Å']); $('input[name="to"]').val(d['‡∏ñ‡∏∂‡∏á']); $('input[name="remark"]').val(d['‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']);
        if(d['‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']) { const p=d['‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'].split('/'); if(p.length===3) $('input[name="date"]').val(`${p[2]}-${p[1]}-${p[0]}`); }
    }
    new bootstrap.Modal('#dataModal').show();
}
function submitForm() {
    const fd = new FormData($('#docForm')[0]); Swal.fire({title:'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', didOpen:()=>Swal.showLoading()});
    fetch('/submit', {method:'POST', body:fd}).then(r=>r.json()).then(d=>{
        if(d.status==='success') Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success').then(()=>{ bootstrap.Modal.getInstance(document.getElementById('dataModal')).hide(); loadTable($('#fSheet').val(), 'edit'); });
        else Swal.fire('Err', d.message, 'error');
    });
}
</script>
</body>
</html>
